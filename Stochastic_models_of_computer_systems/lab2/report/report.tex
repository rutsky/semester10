% Report.
%
% Copyright (C) 2011  Vladimir Rutsky <altsysrq@gmail.com>
%
% This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 
% Unported License. See <http://creativecommons.org/licenses/by-sa/3.0/> 
% for details.

\documentclass[a4paper,10pt]{article}

% Encoding support.
\usepackage{ucs}
\usepackage[utf8x]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}

\usepackage{amsmath, amsthm, amssymb}
\usepackage{commath}

% Indenting first paragraph.
\usepackage{indentfirst}

\usepackage{url}
\usepackage[unicode]{hyperref}

%\usepackage[final]{pdfpages}

\usepackage[pdftex]{graphicx}
\usepackage{subfig}

\usepackage{fancyvrb}
\usepackage{color}
\usepackage{texments}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}

% Spaces after commas.
\frenchspacing
% Minimal carrying number of characters,
\righthyphenmin=2

% From K.V.Voroncov Latex in samples, 2005.
\textheight=24cm   % text height
\textwidth=16cm    % text width.
\oddsidemargin=0pt % left side indention
\topmargin=-1.5cm  % top side indention.
\parindent=24pt    % paragraph indent
\parskip=0pt       % distance between paragraphs.
\tolerance=2000
%\flushbottom       % page height aligning
%\hoffset=0cm
%\pagestyle{empty}  % without numeration

\newcommand{\myemail}[1]{%
\href{mailto:#1}{\nolinkurl{#1}}}

\newcommand{\myfunc}[1]{%
\textit{#1}}

\begin{document}

% Title page.
\input{./title.tex}
%\tableofcontents
%\pagebreak

% Content

\section{Постановка задачи}
Данной работе производится анализ лога загруженности процессора сервера
при поступающих заявках на обработку информации.
% TODO: Лучше рассматривать измерение абстрактных величин~--- загрузка 
% ресурсов сервера.

В отсутствие заявок величина загруженности процессора представляет собой 
сумму некоторой постоянной величины загрузки $m$ и случайных отклонений:
$$B(t) = m + \sigma \mathcal{W}(t),$$
где $\mathcal{W}(t)$~--- это винеровский процесс.

Интенсивность поступления заявок подчиняются закону
распределения Пуассона $\mathcal{P}(\lambda)$.
% TODO: Лучше было бы рассматривать $\lambda = \lambda(t)$

При поступлении одной заявки нагрузка на процессор мгновенно возрастает,
а затем экспоненциально снижается до прежнего уровня.
Увеличение загрузки процессора от одной заявки, 
поступившей в момент времени $t_c$ выражается следующим образом:
$$K_{t_c}(t) = \mathcal{N}(m_c, \sigma_c^2) \cdot \mathrm{I}(t - t_c) \cdot 
    e^{-\lambda_c(t - t_c)},$$
где $\mathrm{I}(x)$~--- фунцкия Хевисайда.%
\footnote{%
Функция Хевисайда: $\mathrm{I}(x) = \left\{
  \begin{array}{rl}
    0, & x < 0 \\
    1, & x \geqslant 0
  \end{array}\right.$.
}
% Экспоненциальное падение можно обосновать с помощью ТМО.
% d K(t) = -\lambda K'(t) dt

В логе загруженности процессора наблюдается общая загрузка процессора:
$$X(t) = B(t) + \sum\limits_{t_c \in T_c}K_{t_c}(t),$$
где $T_c$~--- это моменты времени поступления заявок.

Необходимо по дискретным наблюдениям $X(t_i), \quad i=1,\ldots,N$
\begin{enumerate}
 \item оценить моменты времени поступления заявок $T_c$,
 \item оценить параметры модели $m$, $\sigma$, $\lambda$, $m_c$, 
 $\sigma_c^2$, $\lambda_c$.
\end{enumerate}
Наблюдения производятся через равные промежутки времени 
$\Delta t = t_{i+1} - t_i.$

Для упрощения решения $\lambda_c$ принимается равным величине близкой к нулю,
т.\,е.~каждая пришедшая заявка увеличивает загрузку процессора на некоторую 
фиксированную величину.

\section{Решение}
\subsection{Оценка моментов времени поступления заявок}
Предположим, что в отрезке времени $[t_k, t_{k+n+1}]$ не пришло ни одной заявки.
Тогда наблюдения $X(t_k),\ldots,X(t_{k+n+1})$ представляют собой наблюдения
$B(t)$.
Оценим по этим наблюдениям параметры $B(t)$.

Рассмотрим разности соседних наблюдений~--- они представляют собой наблюдения 
нормально распределённой случайной величины:
$$B(t_{i+1}) - B(t_i) = 
    \sigma \mathcal{W}(t_{i+1}) - \sigma \mathcal{W}(t_i) = 
    \sigma \mathcal{N}(0, \Delta t) = 
    \mathcal{N}(0, \sigma^2 \Delta t).$$

Построим точечную оценку $\widehat{\sigma}$ методом максимального правдоподобия:%
\footnote{\S\,3.5 пункт~1 в~\cite{ivchmed2010matstat}.}
$$\widehat{\sigma}^2 = 
    \frac{1}{\Delta t}\cdot\frac{1}{n-1}
        \sum\limits_{i=1}^n ((X(t_{k+i+1}) - X(t_{k+i})) - 0)^2.$$

Обозначим гипотезу о том, что в промежутке времени 
$[t_{k+n+1}, t_{k+n+2}]$ не пришло ни одной заявки, 
как $H_0$.
Тогда 
$$\mathcal{L}(X(t_{k+n+2})-X(t_{k+n+1}) | H_0) = 
    \mathcal{N}(0, \sigma^2 \Delta t).$$

В качестве статистики для отвержения гипотезы $H_0$ возьмём вероятность 
наблюдения $X(t_{k+n+2})$:
$$T(X_{k+n+2}) = 
    \mathbf{P}\big(B(t_{k+n+2})= X(t_{k+n+2})\big) = 
    \mathbf{P}\big(
      \mathcal{N}(0, \widehat{\sigma}^2 \Delta t) = 
                     X(t_{k+n+2})-X(t_{k+n+1})\big),$$
а критерием отвержения гипотезы $H_0$ с уровнем значимости $\alpha$ 
будет служить следующее выражение:
$$H_0 \  \mathrm{\text{отвергается}} \Longleftrightarrow 
    T(X_{k+n+2}) < \alpha.$$

Алгоритм нахождения моментов времени поступления заявок $T_c$ 
состоит в следующем:
\begin{enumerate}
  \item В предположении, что в первые $n+1$ наблюдений не пришло ни одной 
  заявки, оценим $\widehat{\sigma}$ и построим критерий для отвержения $H_0$.
  \item Будем добавлять к первым $n+1$ наблюдениям по одному наблюдению и 
  проверять гипотезу $H_0$.
  Если $H_0$ не отвергается, то $\widehat{\sigma}$ и критерий для отвержения $H_0$ 
  пересчитываются для добавленного наблюдения.
  \item Как только встретиться наблюдение $n+1+l$, для которого гипотеза $H_0$
  отвергается, то \mbox{$t_{n+1+l} \in T_c$}. 
  Все наблюдения до $t_{n+1+l+1}$ отбрасываются и алгоритм начинается с шага 1
  для поиска следующего момента времени прихода заявки.
\end{enumerate}

\subsection{Оценка интенсивности поступления заявок $\lambda$}
Зная время прибытия заявок $T_c$ интенсивность поступления заявок можно оценить
методом максимального правдоподобия:
\footnote{{\url{http://en.wikipedia.org/wiki/Poisson\_distribution\#Maximum\_likelihood}} 
или в общем случае в \S\,3.5 пункт~1 в~\cite{ivchmed2010matstat}.}
$$\widehat{\lambda} = 
    \frac{1}{|T_c|} \sum\limits_{i=0}^{|T_c| - 1} (t_{c_{i+1}} - t_{c_i}).$$

\subsection{Оценка параметров распределения величины нагрузки %
поступающих заявок}
Рассмотрим ненормированный разностный аналог производной $X(t)$:
$$\dif X(t) = X(t) - X(t - \Delta t).$$

$\operatorname{d}X(t)$ в момент времени прихода заявки $t_c$ 
выражается следующим образом:
\begin{eqnarray*}
\dif X(t_c) 
  & = & X(t_c) - X(t_c - \Delta t) = 
      B(t_c) + K_{t_c}(t_c) - B(t_c - \Delta t) = \\
  & = & \sigma \mathcal{W}(t_c) - \sigma \mathcal{W}(t_c - \Delta t) + 
      \mathcal{N}(m_c, \sigma_c^2) = \\
  & = & \sigma \mathcal{N}(0, \Delta t) + \mathcal{N}(m_c, \sigma_c^2) =
      \mathcal{N}(m_c, \sigma^2 \Delta t + \sigma_c^2),
\end{eqnarray*}
предполагая, что в момент времени $t_c - \Delta t$ заявки не было.
%Число таких наблюдений равно $|T_c|$.

Во время отсутствия заявок $\dif X(t)$ выражается как:
$$
\dif X(t) = X(t) - X(t - \Delta t) = 
    B(t) - B(t - \Delta t) =
    \mathcal{N}(0, \sigma^2 \Delta t).
$$

Значит $\dif X(t)$ представляет собой наблюдение смеси двух нормально 
распределённых случайных величин.
Оценим их параметры EM-алгоритмом.

Введём скрытые случайные величины $Z_i, \quad i=1,\ldots,N$, 
принимающие значения 1 или 2, в зависимости от того, 
пришла ли заявка в момент времени $t_i$ или нет соответственно.
$$
\diff X(t_i) \vert (Z_i = 1)
$$


\section{Результаты работы}

%\appendix
%\section{Исходный код}
%\label{appendix:sources}

%\usestyle{default}

%\subsection{Title}
%\label{appendix:sources:sources-name}
%\includecode[python -O linenos=1]{data/source.py}

\pagebreak

\bibliographystyle{unsrt}
\bibliography{references}

\end{document}
